@using Application.DTOs
@model GenerateSeatsDto

@{
    ViewData["Title"] = "Місця";
    var error = ViewBag.SeatsError as string;

    var grouped = Model.Seats
        .GroupBy(s => s.RowNumber)
        .OrderBy(g => g.Key)
        .ToList();

    var maxSeats = grouped.Count == 0 ? 0 : grouped.Max(g => g.Count());
}

<section class="seats-page py-4 py-lg-5">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3 mb-4">
            <div>
                <div class="text-muted small mb-1">Зал</div>
                <h1 class="page-title mb-0">
                    Місця: <span class="text-maroon">@Model.HallName</span>
                </h1>
            </div>

            <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                <a asp-action="Index" class="btn btn-soft">
                    <i class="fas fa-arrow-left me-2"></i>Повернутися до залів
                </a>

                @if (!string.IsNullOrWhiteSpace(Model.LockReason))
                {
                    <span class="pill pill-warning">
                        <i class="fas fa-lock me-2"></i>Редагування вимкнено
                    </span>
                }
            </div>
        </div>

        <div class="card card-modern shadow-sm">
            <div class="card-header card-header-modern">
                <div class="d-flex align-items-center gap-3">
                    <div class="icon-badge">
                        <i class="fas fa-chair"></i>
                    </div>
                    <div>
                        <div class="header-title">Керування місцями</div>
                        <div class="header-subtitle">Налаштування рядів, генерація та схема залу</div>
                    </div>
                </div>
            </div>

            <div class="card-body p-3 p-lg-4">
                @if (!string.IsNullOrWhiteSpace(error))
                {
                    <div class="alert alert-danger d-flex align-items-start gap-2 mb-3" role="alert">
                        <i class="fas fa-exclamation-triangle mt-1"></i>
                        <div>@error</div>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Model.LockReason))
                {
                    <div class="alert alert-warning d-flex align-items-start gap-2 mb-3" role="alert">
                        <i class="fas fa-info-circle mt-1"></i>
                        <div>
                            <div class="fw-semibold">Заблоковано</div>
                            <div class="small opacity-75">@Model.LockReason</div>
                        </div>
                    </div>
                }

                @if (!Model.AlreadyGenerated)
                {
                    <div class="panel mb-4">
                        <div class="panel-head">
                            <div>
                                <div class="panel-title">
                                    <i class="fas fa-table me-2"></i>1) Налаштування рядів
                                </div>
                                <div class="panel-hint">Задай базову структуру, щоб швидко створити конфіг</div>
                            </div>
                        </div>

                        <form method="post" asp-action="ConfigureSeats" class="mt-3">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="hallId" value="@Model.HallId" />

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Кількість рядів</label>
                                    <div class="input-group input-group-modern">
                                        <span class="input-group-text"><i class="fas fa-layer-group"></i></span>
                                        <input type="number" name="rows" min="1" value="@Model.Rows" class="form-control"
                                        @(Model.CanEditSeats ? "" : "disabled") />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Місць у кожному ряді</label>
                                    <div class="input-group input-group-modern">
                                        <span class="input-group-text"><i class="fas fa-grip-horizontal"></i></span>
                                        <input type="number" name="seatsPerRow" min="1" value="@Model.SeatsPerRow" class="form-control"
                                        @(Model.CanEditSeats ? "" : "disabled") />
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-3">
                                <button type="submit" class="btn btn-maroon btn-modern" @(Model.CanEditSeats ? "" : "disabled")>
                                    <i class="fas fa-cogs me-2"></i>Побудувати таблицю
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="panel">
                        <div class="panel-head">
                            <div>
                                <div class="panel-title">
                                    <i class="fas fa-pen me-2"></i>2) Редагування місць у рядах
                                </div>
                                <div class="panel-hint">Можеш змінити кількість місць окремо в кожному ряді</div>
                            </div>
                        </div>

                        @if (!Model.CanEditSeats)
                        {
                            <div class="alert alert-secondary mt-3 mb-0">
                                Редагування місць вимкнене.
                            </div>
                        }
                        else
                        {
                            <form method="post" asp-action="GenerateSeats" class="mt-3">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="hallId" value="@Model.HallId" />

                                <div class="table-responsive">
                                    <table class="table table-modern align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th class="col-row">Ряд</th>
                                                <th class="col-seats">Кількість місць</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int i = 0; i < Model.RowConfigs.Count; i++)
                                            {
                                                <tr>
                                                    <td class="fw-semibold">
                                                        #@Model.RowConfigs[i].RowNumber
                                                        <input type="hidden" name="rowConfigs[@i].RowNumber" value="@Model.RowConfigs[i].RowNumber" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="rowConfigs[@i].SeatsCount" min="1"
                                                               value="@Model.RowConfigs[i].SeatsCount"
                                                               class="form-control form-control-sm" />
                                                    </td>
                                                    <td class="text-end text-muted small">
                                                        <i class="fas fa-chair me-1"></i>місць
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <div class="d-flex justify-content-end mt-3">
                                    <button type="submit" class="btn btn-maroon btn-modern">
                                        <i class="fas fa-check me-2"></i>Згенерувати місця
                                    </button>
                                </div>
                            </form>
                        }
                    </div>
                }
                else
                {
                    <div class="panel mb-4">
                        <div class="panel-head">
                            <div>
                                <div class="panel-title">
                                    <i class="fas fa-check-circle me-2"></i>Місця вже створені
                                </div>
                                <div class="panel-hint">За потреби можна перегенерувати (видалить поточні місця)</div>
                            </div>
                        </div>

                        <form method="post" asp-action="GenerateSeats" class="mt-3" onsubmit="return confirmRegenerate();">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="hallId" value="@Model.HallId" />

                            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="allowRegenerate" value="true"
                                           id="allowRegenerate" @(string.IsNullOrWhiteSpace(Model.LockReason) ? "" : "disabled") />
                                    <label class="form-check-label" for="allowRegenerate">
                                        Перегенерувати (усі місця буде видалено)
                                    </label>
                                </div>

                                <button type="submit" class="btn btn-danger btn-modern"
                                @(string.IsNullOrWhiteSpace(Model.LockReason) ? "" : "disabled")>
                                    <i class="fas fa-trash-alt me-2"></i>Перегенерувати
                                </button>
                            </div>
                        </form>
                    </div>

                    @if (grouped.Count == 0)
                    {
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-chair"></i></div>
                            <div class="empty-title">Місця відсутні</div>
                            <div class="empty-sub">Спробуй перегенерувати або перевір конфіг рядів.</div>
                        </div>
                    }
                    else
                    {
                        <div class="panel">
                            <div class="panel-head">
                                <div>
                                    <div class="panel-title">
                                        <i class="fas fa-th me-2"></i>Схема залу
                                    </div>
                                    <div class="panel-hint">Відображення створених місць (порожні — “–”)</div>
                                </div>
                            </div>

                            <div class="screen mt-3">
                                <div class="screen-label">ЕКРАН</div>
                            </div>

                            <div class="table-responsive mt-3">
                                <table class="table table-modern table-seats align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th class="col-row">Ряд</th>
                                            @for (int i = 1; i <= maxSeats; i++)
                                            {
                                                <th class="text-center seat-col">@i</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var row in grouped)
                                        {
                                            var seatsInRow = row.OrderBy(x => x.SeatNumber).ToList();

                                            <tr>
                                                <td class="fw-semibold">#@row.Key</td>

                                                @for (int s = 1; s <= maxSeats; s++)
                                                {
                                                    var exists = seatsInRow.Any(x => x.SeatNumber == s);

                                                    <td class="text-center">
                                                        @if (exists)
                                                        {
                                                            <span class="seat-badge">@s</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="seat-empty">–</span>
                                                        }
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        function confirmRegenerate() {
            const allow = document.querySelector('input[name="allowRegenerate"]');
            if (allow && allow.checked) {
                return confirm("Перегенерація видалить усі існуючі місця. Продовжити?");
            }
            alert("Для перегенерації необхідно поставити галочку.");
            return false;
        }
    </script>
}
